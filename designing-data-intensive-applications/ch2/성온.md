# 새롭게 알게된 점

일대다, 다대다 관계에 적합한 모델은 무엇인가?

애플리케이션의 요구사항에 맞는 최적의 기술을 선택해야 한다.

# 어려웠거나 이해하지 못한 점

# 추가 내용

정리

- 데이터 모델은 크게 계층 모델, 관계형 모델, 비관계형 모델로 나뉜다.
    
    계층 모델
    
    - 초기에 고안된 모델
    - 데이터를 하나의 큰 트리로 표현하려고 했지만 다대다 관계를 표현하기엔 트리구조가 적절하지 않았음
    
    관계형 모델
    
    - 다대다 관계를 표현하기 위해 고안되었음
    - 그러나 관계형 모델에도 적합하지 않은 애플리케이션이 있다는 사실이 발견되었음
    
    비관계형 모델
    
    - 문서 데이터베이스와 그래프 데이터베이스가 있음
    - 문서 데이터베이스: 데이터가 문서 자체에 포함되어 있으면서 하나의 문서에 다른 문서 간 관계가 거의 없는 사용 사례를 대상으로 함
    - 그래프 데이터베이스: 문서 데이터베이스와는 정반대로 모든 것이 잠재적으로 관련 있다는 사용 사례를 대상으로 함
    
    세 가지 모델(관계, 문서, 그래프)는 모두 현재 널리 이용되고 있다. 각자의 특정이 있으므로 각 목적에 맞는 다양한 시스템을 보유해야 한다.
    

느낀 점

- 각 데이터베이스 시스템의 특성과 장단점을 이해하자.
- 상황에 맞는 데이터베이스 시스템을 사용하자.
- 구체적인 사례까지 깊게 이해할 필요는 없을 것 같다. 가볍게 보고 관통하는 유의하고 넘어가자는 생각이 강했다.

생각해보기

- 본인이 맡은 서비스에서 사용하는 데이터베이스 모델과 예시를 들어보아요.
    - 대부분은 관계형 데이터베이스를 사용하며 비즈니스 요구사항을 충족할 수 있음
        - 관계형 데이터베이스: 트랜잭션 처리(상품 구매, 예약), 일괄 처리(통계)
    - 최근 일부 컴포넌트에서 문서 데이터베이스 (몽고디비)을 도입한 사레가 있음
        - 목적은 알림(광고성 알림 대량 전송), 로그 분석(엑세스 로그를 분석하여 알림 대상자 추출)
        - 스키마 유연성, 지역성, 애플리케이션에서 사용하는 데이터 구조와 가까움
- 그래프형 데이터 모델을 사용한 사례 or 경험이 있는가?

---

# 내용 정리

다루는 내용

- 데이터 저장과 질의를 위한 다양한 범용 데이터 모델 살펴보기
- 관계형 모델(relational model), 문서 모델(document model), 그래프 기반 모델(graph-based data model) 비교

## 관계형 모델과 문서 모델

데이터는 관계(relation, 또는 테이블)로 구성되고 각 관계는 순서 없는 튜플(tuple, 또는 로우) 모음이다.

사용사례로는 트랜잭션 처리나 일괄 처리가 있다.

- 트랜잭션 처리: 영업, 은행 거래, 항공 예약, 창고 재고 보관
- 일괄 처리: 고객 송장 작성, 급여 지불, 보고

### NoSQL 의 탄생

`Not Only SQL`로 재해석 됐다.

NoSQL 데이터베이스 채택 원동력

- 대규모 데이터셋이나 매우 높은 쓰기 처리량 달성을 관계형 데이터베이스보다 쉽게 할 수 있는 확장성 필요
- 상용 데이터베이스 제품보다 무료 오픈소스 소프트웨어에 대한 선호도 확산
- 관계형 모델에서 지원하지 않는 특수 질의 동작
- 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

NoSQL 추가 내용

- NoSQL 의 원래 의미는 non SQL 이었다. 전통적인 관계형 데이터베이스보다 덜 제한적인 모델은 제공하는 것이다. 디자인의 단순화, 수평적 확장성, 세세한 통제를 포함한다.

[NoSQL - 위키백과, 우리 모두의 백과사전](https://ko.wikipedia.org/wiki/NoSQL)

- NoSQL은 키 값, 문서, 컬럼 및 그래프 형식을 포함한 다양한 데이터 모델을 수용할 수 있는 데이터베이스 관리에 대한 접근 방식이다. NoSQL 데이터베이스는 일반적으로 비관계형, 분산형, 유연성 및 확장성을 의미한다. 일반적인 NoSQL 데이터베이스 기능에는 관계형 및 SQL 데이터베이스의 일반적인 ACID(원자성, 일관성, 분리 및 내구성) 트랜잭션 일관성과 달리 데이터베이스 스키마, 데이터 클러스터링, 복제 지원 및 궁극적인 일관성이 포함됩니다. 많은 NoSQL 데이터베이스 시스템도 오픈 소스이다
- SQL의 유용성으로 인해 많은 NoSQL 데이터베이스가 SQL에 대한 지원을 추가하게 되었고 오늘날 NoSQL 은 Not Only SQL 을 의미하는 것으로 일반적으로 받아들여지고 있다.

[What is NoSQL and How do NoSQL Databases Work?](https://www.techtarget.com/searchdatamanagement/definition/NoSQL-Not-Only-SQL)

### 객체 관계형 불일치

오늘날 대부분의 애플리케이션은 객체지향 프로그래밍 언어로 개발한다. 그런데 데이터를 관계형 테이블에 저장하려면 애플리케이션 코드와 데이터베이스 모델 사이에 거추장스러운 전환 계층이 필요하다. 이런 모델 사이의 분리를 종종 임피던스 불일치라고 부른다.

이력서 같은 데이터 구조는 모든 내용을 갖추고 있는 문서라서 JSON 표현에 적합하다. JSON 은 표현은 다중 테이블 스키마보다 더 나은 `지역성(locality)`을 갖는다.

- 관계형 예제에서 프로필을 가져오려면 다중 질의를 수행하거나 다중 조인을 수행해야 한다.
- JSON 표현에는 모든 관련 정보가 한 곳에 있어 질의 하나로 충분하다.

### 다대일(many-to-one)과 다대다(many-to-one) 관계

지역, 회사명을 평문이 아닌 별도 아이디로 관리하면 아래 장점을 취할 수 있다.

- 프로필 간 일관된 스타일과 철자
- 모호함 회피(같은 이름이 여러개 있을 경우)
- 갱신의 편의성. 이름이 한 곳에만 저장되므로 이름을 변경해야 할 때 전반적으로 갱신하기 쉽다.
- 현지화 지원. 사이트를 다른 언어로 번역할 때 표준 목록을 현지화해 지역과 업계를 사이트를 보는 사람의 언어로 표시할 수 있다.
- 더 나은 검색. 예를 들어 워싱턴 주에 있는 자선가를 검색할 때 지역 목록에 시애틀이 워싱턴에 있다는 사실을 부호화 할 수 있기 때문에 원하는 프로필을 찾을 수 있다.

중복된 데이터를 정규화하려면 다대일(many-to-one)관계가 필요하다.

- 관계형 데이터베이스에서는 조인이 쉽기 때문에 ID로 다른 테이블의 로우를 참조할 수 있다.
- 문서 데이터베이스에서는 일대다 트리 구조를 위해 조인이 필요하지 않지만 조인에 대한 지원이 보통 약하다.
    - MongoDB 는 join 을 지원하지 않는다. 3.2 부터는 Join과 비슷한 역할을 하는 `$lookup` 을 지원하고 있다.

### 문서 데이터베이스는 역사를 반복하고 있나?

관계형 데이터베이스는 일상적으로 다대다 관계와 조인을 사용하지만 문서 데이터베이스와 NoSQL은 데이터베이스에서 다대다 관계를 표현하는 제일 좋은 방법에 대한 논쟁을 다시 열었다.

모델

- 계층 모델: 간단한 모델. 문서 데이터베이스처럼 일대다에선 잘 동작하나 다대다 관계 표현은 어려웠고 조인은 지원하지 않았음
- 관계형 모델: SQL이 되어 세상을 지배함
- 네트워크 모델: 초기에는 많은 신봉자들이 있었지만 후에 잊혀짐

네트워크 모델

- 코다실(Conference on Data Systems Languates, CODASYL) 이라 불리는 위원회에서 표준화함
- 코다실 모델이라고도 하며 계층 모델을 일반화함
- 계층 모델의 트리 구조에서 모든 레코드는 정확하게 하나의 부모가 있으나 네트워크 모델에서 레코드는 다중 부모가 있을 수 있음
- 다대일과 다대다 관계를 모델일 할 수 있음
- 레코드 간 연결은 외래 키 보다는 프로그래밍 언어의 포인터와 더 비슷함
- 레코드에 접근하는 유일한 방법은 최상회 레코드(root record)에서부터 연속된 연결 경로를 따르는 방법. `접근 경로`
- 매번 접근 경로를 추척해야 함

관계형 모델

- 관계형 모델이 하는 일은 알려진 모든 데이터를 배치하는 것이다.
- 관계(테이블)는 단순히 튜플(로우)의 컬렉션이 전부다.
- 질의 최적화기(query optimizer)는 질의의 어느 부분을 어떤 순서로 진행할지 결정하고 사용할 색인을 자동으로 결정한다.

문서 데이터베이스와의 비교

- 별도 테이블이 아닌 상위 레코드 내에 중첩된 레코드를 저장한다.

### 관계형 데이터베이스와 오늘날의 문서 데이터베이스

둘을 비교하는 경우 내결함성(5장)과 동시성 처리(7장)을 포함해 고려해야할 차이점이 많다. 이번 장에서는 데이터 모델의 차이점에만 집중한다.

- 문서 데이터 모델을 선호하는 주요 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능 때문이고 일부 애플리케이션의 경우 애플리케이션에서 사용하는 데이터 구조와 더 가깝기 때문이다.
- 관계형 모델은 조인, 다대일, 다대다 관계를 더 잘 지원한다.

어떤 데이터 모델이 애플리케이션  코드를 더 간단하게 할까?

- 데이터와 문서가 비슷한 구조(일대다 관계 트리로 보통 한 번에 전체 트리를 적재)라면 문서 모델을 사용하는 것이 좋다.
- 문서와 비슷한 구조를 여러 테이블로 나눠 찢는(shredding) 관계형 기법은 다루기 힘든 스키마와 불필요하게 복잡한 애플리케이션 코드를 발생시킨다.
- 문서 모델에서 중첩 항목을 바로 참조할 수 없는 제한이 있지만 너무 깊게 중첩되지 않으면 문제되지 않는다.
- 문서 모델의 미흡한 조인 지원은 애플리케이션에 따라 문제가 될 수 있고 안될 수도 있다. 어떤 시점에 발생하는 이벤트를 기록하는 문서 데이터베이스를 사용하는 분석 애플리케이션에서는 다대다 관계가 결코 필요하지 않다.
- 하지만 애플리케이션에서 `다대다` 관계를 사용하면 문서 모델의 매력은 떨어진다.
    - 비정규화로 조인을 줄일 수 있지만 비정규화된 데이터의 일관성을 유지하기 위해 추가작업을 해야한다.
    - 조인을 애플리케이션 코드에서 흉내낼 수 있지만 반대로 코드가 복잡해진다.

문서 모델에서의 스키마 유연성

- 문서 데이터베이스는 종종 스키마리스(schemaless)로 불리지만 사실 암묵적인 스키마가 있으며 이를 강요하지 않는다는 뜻이 더 맞다.
    - `쓰기 스키마(schema-on-write)`: 관계형 데이터베이스의 전통적인 접근 방식으로 스키마는 명시적이고 데이터베이스는 쓰여진 모든 데이터가 스키마를 따르고 있음을 보장한다.
    - `읽기 스키마(schema-on-read)`: 데이터 구조는 암묵적이고 데이터를 읽을때만 해석된다.
- 읽기 스키마 접근 방식은 컬렉션 안의 항목이 어떤 이유로 모두 동일한 구조가 아닐 때 유리하다. 아래 상황에서 스키마는 득보다 실이 많다.
    - 다른 여러 유형의 오브젝트가 있고 각 유형의 오브젝트별로 자체 테이블에 넣는 방법은 실용적이지 않다.
    - 사용자가 제어할 수 없고 언제나 변경 가능한 외부 세스템에 의해 데이터 구조가 결정된다.

질의를 위한 데이터 지역성

- 애플리케이션이 자주 전체 문서에 접근해야 할 때 저장소 지역석(storage locality)을 활용하면 성능 이점이 있다.
- 지역성의 이점은 한 번에 문서의 많은 부분을 필요할 때 적용된다.
- 결론: 문서를 적절한 크기로 관리해야 하며, 문서의 크기가 증가하는 쓰기를 피해야 이 이점을 살릴 수 있다.
- 지역성을 위해 관련 데이터를 그룹화하는 개념은 다른 모델에도 있다.
    - 구글의 스페너 데이터베이스
    - 오라클의 다중 테이블 색인 클러스터 테이블
    - 빅테이블 데이터 모델의 칼럼 패밀리 개념(카산드라의 HBase 에서 사용)

문서 데이터베이스와 관계형 데이터베이스의 통합

- 관계형에선 PostgreSQL 은 9.3 부터, MySQL 은 5.7 부터, IBM DB2 는 10.5 부터 JSON 문서에 대해 비슷한 수준의 기능 지원을 제공한다.
- 문서에선 리싱크DB는 질의 언어에서 관계형 조인을 지원하고 MongoDB 드라이버는 자동으로 데이터베이스 참조를 확인한다.
- 결론: 시간이 지나면서 두 모델이 서로의 부족한 부분을 보완하면서 점점 비슷해지고 있다.

## 데이터를 위한 질의 언어

SQL의 선언형 질의 언어와 명령형 코드를 비교하고 있다.

SQL이나 관계 대수 같은 선언형 질의 언어에서는 목표를 달성하기 위한 방법이 아니라 알고자 하는 데이터의 패턴, 즉 결과가 충족해야 하는 조건과 데이터를 어떻게 변환(정렬, 그룹화, 집계)할지를 지정하기만 하면 된다.
→ `결과의 패턴만 지정`

선언형 질의 언어는 일반적으로 명령형API 보다 더 간결하고 쉽게 작업할 수 있다. 데이터베이스의 엔진의 상세 구현이 숨겨져 있어 질의를 변경하지 않고도 데이터베이스 시스템의 성능을 향상시킬 수 있다.

### 웹에서의 선언형 질의

태그 예시

css selector 를 통해서 스타일을 적용하려는 엘리먼트의 패턴을 선언할 수 있다.

만약 javascript 코드로 (명령형) 특정 조건을 만족하는 엘리먼트를 찾고 속성을 변경시키려 했다면 더 복잡했을 것이다.

### 맵리듀스 질의

맵리듀스(MapReduce)는 많은 컴퓨터에서 대량의 데이터를 처리하기 위한 프로그래밍 모델이다.

MongoDB, CouchDB 를 포함한 일부 NoSQL 데이터 저장소는 제한된 형태의 맵리듀스를 제공한다.

이 메커니즘은 많은 문서를 대상으로 일기 전용 질의를 수행할 때 사용한다.

선언형 질의 언어도 명령형 질의 API도 아닌 그 중간 정도에 있다.

MongoDB 2.2 는 집계 파이프라인(aggregation pipeline)이라 부르는 선언형 질의 언어 지원을 추가했다.

## 그래프형 데이터 모델

애플리케이션이 주로 일대다 관계(트리 구조 데이터)이거나 레코드 간 관계가 없다면 문서 모델이 적합하다.

하지만 데이터에서 다대다 관계가 매우 일반적이면 어떻게 해야 할까? 관계형 모델은 단순한 다대다 관계를 다룰 수 있지만 데이터 간 연결이 복잡해지면 그래프로 데이터를 모델링하기 시작하는 편이 더 자연스럽다.

그래프를 이루는 객체

- 정점(vertex 또는 노드, 엔티티)
- 간선(edge 또는 관계, 호 arc)

그래프로 모델링한 데이터 유형

- 소셜 그래프: 정점은 사람이고 간선은 사람들이 서로 알고 있음을 나타낸다.
- 웹 그래프: 정점은 웹 페이지고 간선은 다른 페이지에 대한 HTML 링크를 나타낸다.
- 도로나 철도 네트워크: 정점은 교차로이고 간선은 교차로 간 도로나 철로 선으르 나타낸다.

알려진 알고리즘

- 같은 유형
    - 자동차 내비게이션 시스템은 도로 네트워크에서 두 지점 간 최단 경로를 검색
    - 페이지랭크(pagerank)는 웹 그래프를 사용해 웹 페이지의 인기와 검색 결과에서 순위를 결정
- 다른 유형
    - 페이스북은 다른 여러 유형의 정점과 간선을 단일 그래프로 유지
        - 정점: 사람, 장소, 이벤트, 체크인, 사용자가 작성한 코멘트
        - 간선: 어떤 사람이 서로 친구인지, 어떤 위치에서 체크인이 발생했는지, 누가 어떤 포스트에 코멘트를 했는지, 누가 이벤트에 참석했는지

모델

- 속성 그래프 모델 + 사이퍼 질의 언어
- 트리플 저장소 모델 + 스파클 질의 언어

그래프 모델의 장점

- 정점이 주어지면 정점의 유입과 유출 간선을 효율적으로 찾을 수 있고 그래프를 순회할 수 있다.
    - 관계 모델이었다면 키 값을 가지고 다른 테이블을 참조해야 했다.
- 다른 유형의 관계에 서로 다른 레이블을 사용하면 단일 그래프에서 다른 유형의 정보를 저장하면서도 데이터 모델을 깔끔하게 유지할 수 있다.

### 속성 그래프

정점

- 고유한 식별자
- 유출(outgoing) 간선 집합
- 유입(incoming) 간선 집합
- 속성 컬렉션(key-value pair)

간선

- 고유한 식별자
- 간선이 시작하는 정점(꼬리 정점)
- 간선히 끝나는 정점(머리 정점)
- 두 정점 간 관계 유형을 설명하는 레이블
- 속성 컬렉션(키-값 쌍)

전통적인 관계형 스키마에서 표헌하기 어려운 사례

### 사이퍼 질의 언어

속성 그래프를 위한 질의 언어

### SQL의 그래프 질의

그래프 데이터를 관계형 구조로 넣어도 SQL을 사용해 질의할 수 있을까? 대답은 예 이지만 약간 어렵다.

관계형은 필요한 조인을 미리 알고 있다. 그래프에선 가변적인 간선을 순회해야 하므로 조인 수를 고정할 수 없다.

SQL에선 재귀 공통 테이블 식을 사용해서 표현할 수 있다. 하지만 사이퍼와 비교하면 문법이 매우 어렵다.

### 트리플 저장소와 스파클

트리플 저장소 모델은 속성 그래프 모델과 거의 동등하다.

모든 정보를 아래 세 구문 형식으로 나누어 저장한다. (three-part statements)

- 주어(subject) - 정점
- 서술어(predicate)
- 목적어(object)

### 초석: 데이터로그

스파클, 사이퍼보다 오래된 언어(1980년대 학계에서 연구됨)지만 질의 언어의 기반이 되는 초석을 제공하기 때문에 중요하다.

캐스캘로그(Cascalog)는 데이터로그의 구현체로서 하둡의 대용량 데이터셋에 질의를 위한 용도다.

## 정리

계층 모델, 관계형 모델, 비관계형 모델

계층 모델

- 데이터를 하나의 큰 트리로 표현하려고 했지만 다대다 관계를 표현하기엔 트리구조가 절절하지 않았음

관계형 모델

- 다대다 관계를 표현하기 위해 고안되었음
- 그러나 관계형 모델에도 적합하지 않은 애플리케이션이 있다는 사실이 발견되었음

비관계형 모델

- 문서 데이터베이스와 그래프 데이터베이스가 있음
- 문서 데이터베이스: 데이터가 문서 자체에 포함되어 있으면서 하나의 문서에 다른 문서 간 관계가 거의 없는 사용 사례를 대상으로 함
- 그래프 데이터베이스: 문서 데이터베이스와는 정반대로 모든 것이 잠재적으로 관련 있다는 사용 사례를 대상으로 함

세 가지 모델(관계, 문서, 그래프)는 모두 현재 널리 이용되고 있다. 각자의 특정이 있으므로 각 목적에 맞는 다양한 시스템을 보유해야 한다.

언급되지 않는 다른 데이터 모델들

- 염기 서열 유사도 검색: 하나의 아주 긴 문자열을 가지고, 유사하지만 동일하지 않은 문자열을 대용량 문자열 데이터베이스에서 찾는 작업. 젠뱅크
- 빅데이터 스타일의 대규모 데이터 분석
- 전문(full-text) 검색: 색인 검색
